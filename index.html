<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Han Parrallel</title>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <style >
        * {
            font-family: sans-serif;
        }

        .background path{
            fill: none;
            stroke:#f2f0f7;
            shape-rendering: crispEdges;
            }

        .foreground path {
            fill: none;
            }

        .axis line,
        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
            }

        .brush_p .extent {
            fill-opacity: .3;
            stroke: #fff;
            shape-rendering: crispEdges;
            }

        svg {
            border:1px solid black;
            }

        #chart{
            padding:40px 0;
        }
        #header{
            width:100%;
            float: middle;
        }
        #pie{
            position: relative;
            float: right;
        }
        #parallel{
        }
        #bar_numeric{
            float: left;
        }

        /*button{
        position:absolute;
        margin-left: 12px;
        margin-top:12px;
      }*/
      #scatter{
          width:100%;
          margin: 8%;
          float: left;
      }
      #control_panel{
          width:20%;
          float: left;
      }
      #projected{
          width: 35%;
          float: left;
      }
      #projectedHistory{
          width: 35%;
          float: left;
      }
      #control_panel2{
          float: left;
      }
/*      text{
            font-size: 14px;
      } */
      #dimension_reduction{
          width:1102px;
          margin: 0 auto;
          float: middle;
      }
      .content{
        width:1102px;
        margin: 0 auto;
      }
      .group:after {
          content: "";
          display: table;
          clear: both;
        }
      #pieselection{
            position:absolute;
            bottom:10px;
            right:10px;
      }
      #data_info{
            padding:40px 0;
      }


    </style>

  </head>
  <body>

  <div id = "header" style="text-align:center;">
    <h1> CS573 Final Project: Student Grade Explore</h1>
    <p> 2016Fall:  Han Jiang, Chong Zhou, Haitao Liu</h2>
  </div>
  <div class="content">
        <div id = "data_info" style="text-align:center;">
          <h3>Data Information</h3>
          <p>This data includes student achievement in secondary education of two Portuguese schools in Math subject. Each student has 29 features, the details are followed.</p>
        </div>
      <div id="parallel" style="text-align:center;"></div>

      <div id="chart" class="group" style="text-align:center;">
        <div id="bar_numeric">
          <p>Students Number vs Final Grades</p>
        </div>
        <div id="pie">
          <p>Student Number vs Feature</p>
        </div>
      </div>
  </div>

  <div id = "dimension_reduction" style="text-align:center;">
        <h3 >Diemension Reduction non-linear projection with selected emphasis</h2>
        <p>Dimensionality Reduction is about converting data of very high dimensionality into data of much lower dimensionality such that each of the lower dimensions convey much more information.</p>
        <p>Our interaction is to let user (probably domain expert) to select important features and our projection will give extra weights on these selected features.</p>
  </div>
  <div id="scatter">
      <div id = "control_panel">
          <div id="slider1">Absences Weight
              <form>
                  <input type="radio" name="Absences" value=1 checked> 1
                  <input type="radio" name="Absences" value=2> 2
                  <input type="radio" name="Absences" value=4> 4
                  <input type="radio" name="Absences" value=8> 8
              </form>
          </div>
          <div id="slider2">Reason Weight
              <form>
                  <input type="radio" name="Reason" value=1 checked> 1
                  <input type="radio" name="Reason" value=2> 2
                  <input type="radio" name="Reason" value=4> 4
                  <input type="radio" name="Reason" value=8> 8
              </form>
          </div>
          <div id="slider3">Support Weight
              <form>
                  <input type="radio" name="Support" value=1 checked> 1
                  <input type="radio" name="Support" value=2> 2
                  <input type="radio" name="Support" value=4> 4
                  <input type="radio" name="Support" value=8> 8
              </form>
          </div>
          <div id="slider4">Age Weight
              <form>
                  <input type="radio" name="Age" value=1 checked> 1
                  <input type="radio" name="Age" value=2> 2
                  <input type="radio" name="Age" value=4> 4
                  <input type="radio" name="Age" value=8> 8
              </form>
          </div>
          <div id="slider5">Fjob Weight
              <form>
                  <input type="radio" name="Fjob" value=1 checked> 1
                  <input type="radio" name="Fjob" value=2> 2
                  <input type="radio" name="Fjob" value=4> 4
                  <input type="radio" name="Fjob" value=8> 8
              </form>
          </div>
          <div id="slider6">Mjob Weight
              <form>
                  <input type="radio" name="Mjob" value=1 checked> 1
                  <input type="radio" name="Mjob" value=2> 2
                  <input type="radio" name="Mjob" value=4> 4
                  <input type="radio" name="Mjob" value=8> 8
              </form>
          </div>
          <div id="slider7">Fedu Weight
              <form>
                  <input type="radio" name="Fedu" value=1 checked> 1
                  <input type="radio" name="Fedu" value=2> 2
                  <input type="radio" name="Fedu" value=4> 4
                  <input type="radio" name="Fedu" value=8> 8
              </form>
          </div>
          <div id="slider8">Medu Weight
              <form>
                  <input type="radio" name="Medu" value=1 checked> 1
                  <input type="radio" name="Medu" value=2> 2
                  <input type="radio" name="Medu" value=4> 4
                  <input type="radio" name="Medu" value=8> 8
              </form>
          </div>
          <div id="slider9">Ach Weight
              <form>
                  <input type="radio" name="Ach" value=1 checked> 1
                  <input type="radio" name="Ach" value=2> 2
                  <input type="radio" name="Ach" value=4> 4
                  <input type="radio" name="Ach" value=8> 8
              </form>
          </div>
          <div id="control_panel2">
              <select id="method">
                  <option value="pca">PCA</option>
                  <option value="mds">MDS</option>
                  <option value="tsne">TSNE</option>
                  <option value="isomap">Isomap</option>
              </select>
              <select id="color">
                  <option value="trend">trend</option>
                  <option value="give_up">Give up</option>
              </select>
              <button id="submit">Change</button>
          </div>
      </div>
      <div id = "projected">Current Projection Result</div>
      <div id = "projectedHistory">Last Projection</div>
    </div>


    <script type="text/javascript">


    // Add SVG to div chart
    var margin = {top:40,right:20,bottom:20,left:20};
    var w = 1100 - margin.left - margin.right;
    var h = 300 - margin.top - margin.bottom;
    // var w1 = 186 - margin.left - margin.right;
    // var w2 = 150 - margin.left - margin.right;
    var w2 = 500 - margin.left - margin.right;
    var h2 = 300 - margin.top - margin.bottom;

    //var h = 300 - margin.top - margin.bottom;
    var w3 = 500 - margin.left - margin.right;
    var h3 = 300 - margin.top - margin.bottom;

    var w4 = 1100 - margin.left - margin.right;
    var h4 = 350 - margin.top - margin.bottom;

    var svg1 = d3.select("#parallel")
                .append("svg:svg")
                .attr("width",w + margin.left + margin.right)
                .attr("height",h+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1)
                //.attr("aligh","center");

    var svg2 = d3.select("#bar_numeric")
                .append("svg:svg")
                .attr("width",w2 + margin.left + margin.right)
                .attr("height",h2+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    var svg3 = d3.select("#pie")
                .append("svg:svg")
                .attr("width",w3 + margin.left + margin.right)
                .attr("height",h3+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    var svg4 = d3.select("#data_info")
                .append("svg:svg")
                .attr("width",w4 + margin.left + margin.right)
                .attr("height",h4+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    var data_detail = ["1. studytime - weekly study time","2. failures - number of past class failures","3. goout - going out with friends","4. Dalc - workday alcohol consumption","5. Walc - weekend alcohol consumption","6. absences - number of school absences","7. G1 - first period grade", "8. G2 - second period grade", "9. G3 - final grade", "10. school - student's school","11. sex - student’s sex","12. age - student’s age","13. address - student’s home address type","14. famsize - family size","15. Pstatus - parent’s cohabitation status","16. Medu - mother’s education","17. Fedu - father’s education","18. Mjob - mother’s job","19. Fjob - father’s job","20. reason - reason to choose this school","21. guardian - student’s guardian","22. schoolsup - extra educational support","23. famsup - family educational support","24. paid - extra paid classes within the course subject","25. activities - extra-curricular activities","26. nursery - attended nursery school","27. higher - wants to take higher education","28. internet - Internet access at home","29. romantic - with a romantic relationship"];

    var data_feature = ["studytime", "failures", "goout", "Dalc", "Walc","absences", "G1", "G2", "G3", "school", "sex", "age", "address", "famsize", "Pstatus", "Medu", "Fedu", "Mjob", "Fjob","reason","guardian", "schoolsup", "famsup", "paid", "activities", "nursery", "higher", "internet", "internet"];

    var grade = ["A: 16-20", "B: 14-15", "C: 12-13", "D: 10-11", "F:0-9"];

    var x = d3.scale.ordinal().rangePoints([0, w], 1)
        y = {},
        dragging = {},
        select_dimension = "",
        select_info = [],
        select_student = [];

    var line = d3.svg.line(),
        axis = d3.svg.axis().orient("left"),
        background,
        foreground;

    var xbar = d3.scale.ordinal().rangeBands([0, w2-100],.1).domain(["A","B","C","D","F"]);
    var ybar = d3.scale.linear()
                        .range([h2,0])
                        //.domain([0,150]);
    //bar setup
    var b_xAixs = d3.svg.axis()
                    .scale(xbar)
                    .orient("bottom")
                    //.ticks(5);

    var b_yAixs = d3.svg.axis()
                        .scale(ybar)
                        .orient("left")
                        .ticks(5);

    var b_color = d3.scale.ordinal().range(["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6"]);

    //pie setup
    var pie_color = d3.scale.ordinal().range(["#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac"]);
    var radius = Math.min(w3, h3) / 2;
    var outerR = radius - 25;
    var innerR = 0;
    var arc = d3.svg.arc()
                .outerRadius(outerR)
                .innerRadius(innerR);

    var labelArc = d3.svg.arc()
                        .outerRadius(radius - 60)
                        .innerRadius(radius - 60);
    var pie = d3.layout.pie()
                .sort(null);

    var c_pie,Cate_info,s = "school";


    var c; //initial setup for count number

    //load data

    d3.csv("student_mat_readable.csv",function(students){
		 //console.log(students[0])
        //display category variables
        category_variable = ["school","sex","address","famsize","Pstatus","Mjob","Fjob","reason",
                    "guardian","schoolsup","famsup","paid","activities","nursery","higher",
                    "internet","romantic"];

        select_student = students;
       parallel(students);
       count(students);
       bar(c);

       count_select_cate(s);
       draw_pie();

       //add data detail to div data_info

       var feature_detail = svg4.selectAll("text")
                                .data(data_detail)
                                .enter()
                                .append("text")
                                .text(function(d){
                                    return d;
                                })
                                .attr("x",function(d,i){
                                    if(i<15){
                                    return 50;
                                    }
                                    else{return w4/2 + 50;}
                                })
                                .attr("y",function(d,i){
                                    if(i<15){
                                        return  i *20;
                                    }
                                    else{
                                        return (i-15)*20;
                                    }
                                })
                                .attr("font-size","15px");
        // var a = feature_detail[0][0];
        // console.log(a);


        feature_detail.on("mouseover",function(){
            d3.select(this)//.transition()
                .attr("font-size","22px")
                            .attr("fill","orange");
                })
                .on("mouseout",function(){
                    if(d3.select(this).attr("class") == "clicked"){
                        return;
                    }
                    else{d3.select(this).transition()
                            .attr("font-size","15px")
                            .attr("fill","black");}
                });
//-------------------------------------------------------------------------------------
//
//               parallel coordinate function
//
//-------------------------------------------------------------------------------------
        //Extract the list of dimensions and create a scale for each
    function parallel(data){
        x.domain(dimensions = d3.keys(data[0]).filter(function(d){

            if (d === "studytime"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "failures"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }

            else if (d === "Fedu"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "Dalc"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(students,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "Walc"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(students,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }

            else if (d === "absences"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G1"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G2"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G3"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else{return false;}
            return true;
        }))



        //console.log(dimensions)
        // Add grey background lines for context
        background = svg1.append("svg:g")
                        .attr("class","background")
                        .selectAll("path")
                        .data(data)
                        .enter()
                        .append("svg:path")
                        .attr("d",path)
        // Add colorful foreground lines for focus
        foreground = svg1.append("svg:g")
                        .attr("class","foreground")
                        .selectAll("path")
                        .data(data)
                        .enter()
                        .append("svg:path")
                        .attr("d",path)
                        //.attr("stroke", "#fb6a4a")
                        .attr("stroke", "#9e9ac8")
                        .style("opacity",0.8)


        //Add a group element for each dimension
        var g  = svg1.selectAll(".dimension")
                    .data(dimensions)
                    .enter()
                    .append("svg:g")
                    .attr("class","dimension")
                    .attr("transform", function(d) { return "translate(" + x(d) + ")"; })
                    .call(d3.behavior.drag()
                        .origin(function(d) { return {x: x(d)} ;})//d is the element in dimensions
                        .on("dragstart", function(d) {
                            dragging[d] = x(d);
                            background.attr("visibility", "hidden");
                        })
                        .on("drag", function(d) {
                            dragging[d] = Math.min(w, Math.max(0, d3.event.x));
                           // console.log(dragging);
                            foreground.attr("d", path);
                            dimensions.sort(function(a, b) { return position(a) - position(b); });
                            x.domain(dimensions);
                            g.attr("transform", function(d) { return "translate(" + position(d) + ")"; })
                        })
                        .on("dragend", function(d) {
                            delete dragging[d];
                            transition(d3.select(this)).attr("transform", "translate(" + x(d) + ")");
                            transition(foreground)
                                .attr("d", path);
                            background
                                .attr("d", path)
                                .transition()
                                .delay(500)
                                .duration(0)
                                .attr("visibility", null);
                        }));
        //console.log(dragging)
        // Add an axis and title
        g.append("svg:g")
            .attr("class","axis")
            .each(function(d){
                d3.select(this).call(axis.scale(y[d]));
            })

        var parallel_label = g.append("svg:text")
                              .attr("text-anchor", "middle")
                              .attr("y", -9)
                              .text(String)
                              .attr("fill","black")
                              .attr("font-size","15px")
                              .attr("class","nonclick");

        parallel_label.on("mouseover",function(){
            d3.select(this)//.transition()
                .attr("font-size","22px")
                            .attr("fill","orange");
                })
                .on("mouseout",function(){
                    if(d3.select(this).attr("class") == "clicked"){
                        return;
                    }
                    else{d3.select(this).transition()
                            .attr("font-size","15px")
                            .attr("fill","black");}
                })
                .on("click",function(){

                    if(d3.select(this).attr("class") == "nonclick"){

                      d3.selectAll(".clicked")
                            .attr("fill","black")
                            .attr("font-size","15px")
                            .attr("class","nonclick");//when cilck other text, the clicked text become unclicked.
                      //select_label = d3.select(this).text();
                      //console.log(select_label);
                      //select_index = data_feature.indexOf(select_label);

                      //console.log(select_index);
                      //console.log(data_detail[0][select_index])//.attr("fill", "orange");

                      d3.select(this).attr("fill","orange")
                        .attr("class","clicked")
                        .attr("font-size","22px");
                    }else{
                      d3.select(this).attr("class","nonclick")
                        .attr("font-size","15px")
                        .attr("fill","black");
                    }


                })


            // .append("svg:text")
            // .attr("text-anchor", "middle")
            // .attr("y", -9)
            // .text(String)
            // .attr("fill","black")
            // .attr("font-size",13);

        // Add and store a brush for each axis.
        g.append("svg:g")
            .attr("class", "brush_p")
            .each(function(d) {
                d3.select(this).call(y[d].brush = d3.svg.brush()
                                                    .y(y[d])
                                                    .on("brushstart", brushstart_p)
                                                    .on("brush", brush_p));
            })
            .selectAll("rect")
            .attr("x", -8)
            .attr("width", 16);
    }

//-------------------------------------------------------------------------------------
//               parallel brush
//-------------------------------------------------------------------------------------
        function position(d) {
            var v = dragging[d];
            return v == null ? x(d) : v;

        }

        function transition(g) {
            return g.transition().duration(500);
        }

        function path(d) {
            return line(dimensions.map(function(p) {
            return [position(p), y[p](d[p])]; }));
        }

        function brushstart_p() {
            d3.event.sourceEvent.stopPropagation();
        }


        // Handles a brush event, toggling the display of foreground lines.
        //var c =[];

        //var A, B, C, D, F;

        function brush_p() {
            var actives = dimensions.filter(function(p) { return !y[p].brush.empty(); }),
                extents = actives.map(function(p) { return y[p].brush.extent(); });
                //console.log(extents)
                //console.log(actives)

            //for parallel coordinates
            foreground.style("display", function(d) {
                return actives.every(function(p, i) {//restrict range
                    return extents[i][0] <= d[p] && d[p] <= extents[i][1];
                }) ? null : "none";
            });

            //get selected students when using brush in parallel
            //var select_student;

            select_student = students.filter(function(d){
                return actives.every(function(p, i){//restrict range
                    return extents[i][0] <= d[p] && d[p] <= extents[i][1];
                });
            })
            //console.log(select_student[1]["G3"]);
            //console.log(select_student.length);
            //console.log(count_number);

            //console.log(c)
            //return c

            //count();
            //console.log(c);
            //bar(c);

            count(select_student);
            bar(c);
            count_select_cate(s);
            draw_pie();
            selection.on("change",function(){
                s = this.value;
                count_select_cate(s);
                draw_pie();
                //console.log(s);
            });
            //count_select_cate(s);
            //draw_pie();

        }
        //console.log(c);

        function count(data){
                        //divide student grade in A, B, C, D, and F
            //G3: A:16-20, B: 14-15, C: 12-13, D: 10-11, F:0-9
            //count number of selected students in ABCDF
            var i = 0;
            A = 0 , B = 0 , C = 0 , D = 0 , F = 0;
            c = [];
            while(i<data.length){
                if (data[i]["G3"] <= 20 && 16 <= data[i]["G3"]){
                    A = A +1;//console.log(A);

                }
                else if (data[i]["G3"] <= 15 && 14 <= data[i]["G3"]){
                    B = B + 1;
                }
                else if (data[i]["G3"] <= 13 && 12 <= data[i]["G3"]){
                    C = C + 1;
                }
                else if (data[i]["G3"] <= 11 && 10 <= data[i]["G3"]){
                    D = D + 1;
                }
                else if (data[i]["G3"] <= 9 && 0 <= data[i]["G3"]){
                    F = F + 1;
                };

                i++;
            }
            //console.log(A);
            c.push(A); //console.log(c);
            c.push(B);
            c.push(C);
            c.push(D);
            c.push(F);
            return c
           //console.log(c);

        }

        function bar(data){
            svg2.selectAll(".bar")//.transition()
                .remove();
            svg2.selectAll(".axis")//.transition()
                .remove();
            svg2.selectAll(".title").remove();
            //svg2.selectAll(".barLabel").remove();

            ybar.domain([0,d3.max(data,function(d){return d;})])
            var bars = svg2.append("svg:g")
                            .attr("class","bar")
                            .selectAll("rect")
                            .data(data)
                            .enter()
                            .append("rect")
                            .attr("x",function(d,i){
                                return 25 + i*70;
                            })
                            .attr("y",function(d){
                                //return h2 - ybar(d);
                                return  ybar(d);
                                //return d;
                            })
                            .attr("width",30)
                            .attr("height",function(d){
                                return h2 - ybar(d);
                                //return d;
                            })
                            .attr("fill",function(d,i){
                                return b_color(i);
                            })
                            .attr("opacity",1);


            svg2.append("svg:g")
                .attr("class","axis")
                .attr("transform", "translate(0," + (h2) + ")")
                .call(b_xAixs)
                .append("text");

            svg2.append("svg:g")
                .attr("class","axis")
                .attr("transform", "translate(" + 20 + ",0)")
                .call(b_yAixs);


        }

        var bar_legend = svg2.append("svg:g")
                              .attr("class","bar_legend")
                              .selectAll("rect")
                              .data(grade)
                              .enter()
                              .append("rect")
                              .attr("x",w2 - 70)
                              .attr("y",function(d,i){
                                return 100 + i*18;
                              })
                              .attr("width",10)
                              .attr("height",10)
                              .attr("fill", function(d,i){
                                return b_color(i);
                              });

        var bar_legend_text = svg2.append("svg:g")
                                  .attr("class","bar_legend_text")
                                  .selectAll("text-anchor")
                                  .data(grade)
                                  .enter()
                                  .append("text")
                                  .attr("x",w2 - 57)
                                  .attr("y",function(d,i){
                                    return 110 + i*18;
                                  })
                                  .text(function(d){
                                    return d;
                                  })
                                  .style("font-size","12px")


        var selection = d3.select("#pie")
                            //.append("div")
                            .append("select")
                            .attr("id","pieselection")
                            .on("change",function(){
                                var s = this.value;
                                count_select_cate(s);
                                //svg3.selectAll(".arc").remove();
                                console.log(s);
                                draw_pie();

                            });


        selection.selectAll("option")
                    .data(category_variable)
                    .enter()
                    .append("option")
                    .attr("value",function(d){
                        return d;
                    })
                    .text(function(d){return d});

        //get unique value of picked category
        function count_select_cate(d){
            var cate_info = ["1"];
            select_student.forEach(function(p){
                    //console.log(p);
                for(var i = 0; i<cate_info.length;i++){
                    //console.log("ok")
                    if(cate_info.indexOf(p[d]) !== -1 ){
                        //console.log("this value is already there.");
                    }
                    else{
                        cate_info.push(p[d]);
                        //console.log(cate_info);
                    }
                }
            })
            //console.log(cate_info);
            Cate_info = [];
            for(var i = 1; i<cate_info.length;i++){
                Cate_info.push(cate_info[i]);
            }
            // //console.log(Cate_info);
            // //display_cate_info(Cate_info);
            c_pie = [];
            for(var i = 0; i < Cate_info.length;i++){
                c_pie.push(0);
            }

            for(var i = 0; i< Cate_info.length;i++){
                for(var j = 0;j< select_student.length;j++){
                    if(select_student[j][d] == Cate_info[i]){
                        c_pie[i] = c_pie[i] + 1;
                    }
                }
            }


        }

        function draw_pie(){
            svg3.selectAll(".arc").remove();
            var pieChart = svg3.selectAll("arc")
                        .data(pie(c_pie))
                        .enter()
                        .append("svg:g")
                        .attr("class","arc")
                        .attr("transform", "translate(" + (outerR + 130) + ", " + (outerR+30) + ")");;

            pieChart.append("path")
                    .attr("d",arc)
                    .style("fill",function(d,i){
                        return pie_color(i);
                    })

            pieChart.append("text")
                    .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
                    .attr("dy", ".35em")
                    .text(function(d) { return d.data; })
                    .style("text-anchor","middle");

            svg3.selectAll(".rect").remove();
            var rects = svg3.selectAll("rect")
                            .data(Cate_info)
                            .enter()
                            .append("svg:g")
                            .attr("class","rect");

            rects.append("rect")
                    .attr("x",w3 - 100)
                    .attr("y",function(d,i){
                        return h3/2 + i*20;
                    })
                    .attr("width",12)
                    .attr("height",12)
                    .style("fill",function(d,i){
                        return pie_color(i);
                    })

            rects.append("text")
                    .attr("x", w3 - 80)
                    .attr("y", function(d,i){
                        return h3/2 + 10 + i*20;
                    })
                    .text(function(d){return d})
                    .style("font-size","13px")
                    //.attr("class","title")

        }


     });
    </script>
    <script type="text/javascript">
        var margin = {top:20,right:20,bottom:20,left:20};
        var w11 = 800 - margin.left - margin.right
        var w22 = 370 - margin.left - margin.right;
        var h22 = 370 - margin.top - margin.bottom;
        var op;
        var getdata;
        var historydata;
        var submit_times = 0;
        color_map = d3.scale.ordinal().range(["#fb6a4a","#756bb1"])

        function cleandata(input){
            data = [];
            array = input.trim().split('\n');
            for(i in array){
                if(i==0){
                    data["column"] = [];
                    seq = array[i].trim().split(',');
                    for(j in seq){
                        data["column"].push(seq[j]);
                    }
                }else{
                    obj = {};
                    seq = array[i].trim().split(',');
                    for(j in seq){
                        obj[data["column"][j]] = seq[j];
                    }
                    data.push(obj);
                }
            }
            return data
        }

        var svg5 = d3.select("#projected")
                    .append("svg:svg")
                    .attr("width",w22 + margin.left + margin.right)
                    .attr("height",h22+ margin.top + margin.bottom)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                    .attr("border",1);

        var svg6 = d3.select("#projectedHistory")
                    .append("svg:svg")
                    .attr("width",w22 + margin.left + margin.right)
                    .attr("height",h22+ margin.top + margin.bottom)
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                    .attr("border",1);
        var Absences=1,Reason=1,Support=1,Age=1,Fjob=1,Mjob=1,Fedu=1,Medu=1,Ach=1;

        d3.select("#submit").on("click",function(){
            var method = "method="+d3.select("#method").property("value");
            var color = "color="+d3.select("#color").property("value");
            Absences = d3.select('input[name="Absences"]:checked').property("value");
            Reason = d3.select('input[name="Reason"]:checked').property("value");
            Support = d3.select('input[name="Support"]:checked').property("value");
            Age = d3.select('input[name="Age"]:checked').property("value");
            Fjob = d3.select('input[name="Fjob"]:checked').property("value");
            Mjob = d3.select('input[name="Mjob"]:checked').property("value");
            Fedu = d3.select('input[name="Fedu"]:checked').property("value");
            Medu = d3.select('input[name="Medu"]:checked').property("value");
            Ach = d3.select('input[name="Ach"]:checked').property("value");
            var features = "features="+Absences+","+Reason+","+Support+","+Age+","+Fjob+","+Mjob+","+Fedu+","+Medu+","+Ach;
            request_data(method+"&"+color+"&"+features);
        });
        function request_data(control){
            var url = "/pca_data.csv?"+control
            console.log(url)
            d3.csv(url)
                .get(function(error,data){

                    svg5.selectAll("*").remove();
                    svg6.selectAll("*").remove();

                    if (submit_times>0){
                        historydata = getdata;
                        console.log(historydata);
                        var g_h = svg6.selectAll("g")
                                      .append("g")
                                      .attr("class","history_points");
                        history_scatter();
                    }
                    getdata = data;
                    var g = svg5.selectAll("g")
                                .append("g")
                                .attr("class","points");
                    op = d3.scale.linear()
                            .domain([0,5]).range([0,1]);
                    scatter();
                    submit_times++;
            });
        }
        function scatter(){
            var g = svg5.selectAll(".points");

            yScale =  d3.scale.linear().domain(d3.extent(getdata,function(d){return +d.d2})).range([10,w22-10]);
            xScale =  d3.scale.linear().domain(d3.extent(getdata,function(d){return +d.d1})).range([h22-10,10]);

            g.data(getdata)
            .enter()
            .append("circle")
            .attr("r",4)
            .attr("transform", function(d){
                return "translate(" + (xScale(d.d1)) + "," + yScale(d.d2) + ")";
            })
            .style("fill",function(d){return color_map(d.color);});
        }
        function history_scatter(){
            var g = svg6.selectAll(".history_points");
            yScale =  d3.scale.linear().domain(d3.extent(historydata,function(d){return +d.d2})).range([10,w22-10]);
            xScale =  d3.scale.linear().domain(d3.extent(historydata,function(d){return +d.d1})).range([h22-10,10]);
            g.data(historydata)
            .enter()
            .append("circle")
            .attr("r",4)
            .attr("transform", function(d){
                return "translate(" + (xScale(d.d1)) + "," + yScale(d.d2) + ")";
            })
            .style("fill",function(d){return color_map(d.color);});

        }
    </script>

  </body>
</html>
