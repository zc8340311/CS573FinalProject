<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Han Parrallel</title>
    <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    <style >
        .background path{
            fill: none;
            stroke:#ddd;
            shape-rendering: crispEdges;
            }

        .foreground path {
            fill: none;
            }

        .axis line,
        .axis path {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
            }

        .brush_p .extent {
            fill-opacity: .3;
            stroke: #fff;
            shape-rendering: crispEdges;
            }

        svg {
            border:1px solid black;
            }

        #chart{
            width:100%;
            margin: 3%;
            float: left;
        }
        #category{
            width:100%;;
            float: left;
        }
        #pie{
            width:60%;
            float: left;
        }
        #parallel{
            width:100%;
            float: left;
        }
        #bar_numeric{
            width:40%;
            float: left;
        }
        #chart{
            width:100%;
            float: left;
        }        
        button{
        position:absolute;
        margin-left: 12px;
        margin-top:12px;
      }

    </style>

  </head>
  <body>
  <div id = "header">
    <h1> CS573 Final Project: Student Grade Explore</h1>
    <p> 2016Fall:  Han Jiang, Chong Zhou, Haitao Liu</h2>
  </div>

  <div id = "parallel"></div>

  <div id = "chart">
    <div id = "bar_numeric"></div>
    <div id = "pie"></div>
  </div>
  


    <script type="text/javascript">

    // Add SVG to div chart
    var margin = {top:40,right:20,bottom:20,left:20};
    var w = 1000 - margin.left - margin.right;
    var h = 300 - margin.top - margin.bottom;
    // var w1 = 186 - margin.left - margin.right;
    // var w2 = 150 - margin.left - margin.right;
    var w2 = 500 - margin.left - margin.right;
    var h2 = 300 - margin.top - margin.bottom;

    //var h = 300 - margin.top - margin.bottom;
    var w3 = 500 - margin.left - margin.right;
    var h3 = 300 - margin.top - margin.bottom;

    // var w4 = 500 - margin.left - margin.right;
    // var h4 = 300 - margin.top - margin.bottom;

    var svg1 = d3.select("#parallel")
                .append("svg:svg")
                .attr("width",w + margin.left + margin.right)
                .attr("height",h+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    var svg2 = d3.select("#bar_numeric")
                .append("svg:svg")
                .attr("width",w2 + margin.left + margin.right)
                .attr("height",h2+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    var svg3 = d3.select("#pie")
                .append("svg:svg")
                .attr("width",w3 + margin.left + margin.right)
                .attr("height",h3+ margin.top + margin.bottom)
                .append("svg:g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
                .attr("border",1);

    // var svg4 = d3.select("#bar_info")
    //             .append("svg:svg")
    //             .attr("width",w4 + margin.left + margin.right)
    //             .attr("height",h4+ margin.top + margin.bottom)
    //             .append("svg:g")
    //             .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
    //             .attr("border",1);

    var x = d3.scale.ordinal().rangePoints([0, w], 1)
        y = {},
        dragging = {},
        select_dimension = "",
        select_info = [],
        select_student = [];

    var line = d3.svg.line(),
        axis = d3.svg.axis().orient("left"),
        background,
        foreground;

    var xbar = d3.scale.ordinal().rangeBands([0, w2],.1).domain(["A","B","C","D","F"]);
    var ybar = d3.scale.linear()
                        .range([h2,0])
                        //.domain([0,150]);
    //bar setup
    var b_xAixs = d3.svg.axis()
                    .scale(xbar)
                    .orient("bottom")
                    //.ticks(5);

    var b_yAixs = d3.svg.axis()
                        .scale(ybar)
                        .orient("left");

    var b_color = d3.scale.ordinal().range(["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6"]);

    //pie setup
    var pie_color = d3.scale.ordinal().range(["#f0f9e8","#bae4bc","#7bccc4","#43a2ca","#0868ac"]);
    var radius = Math.min(w3, h3) / 2;
    var outerR = radius - 10;
    var innerR = 0;
    var arc = d3.svg.arc()
                .outerRadius(outerR)
                .innerRadius(innerR);

    var labelArc = d3.svg.arc()
                        .outerRadius(radius - 60)
                        .innerRadius(radius - 60);
    var pie = d3.layout.pie()
                .sort(null);

    var c_pie,Cate_info,s = "school";


    var c; //initial setup for count number

    //load data

    d3.csv("student-mat-readable.csv",function(students){
		 //console.log(students[0])
        //display category variables
        category_variable = ["school","sex","address","famsize","Pstatus","Mjob","Fjob","reason",
                    "guardian","schoolsup","famsup","paid","activities","nursery","higher",
                    "internet","romantic"];


       parallel(students);
       count(students);
       bar(c);

//-------------------------------------------------------------------------------------
//
//               parallel coordinate function
//
//-------------------------------------------------------------------------------------
        //Extract the list of dimensions and create a scale for each
    function parallel(data){
        x.domain(dimensions = d3.keys(data[0]).filter(function(d){
            //if (d ==="ID") {return false;}

            //else if(d==="sex"){return false;}
            // if (d === "age"){
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 .range([h, 0]);
            // }
            // else if (d ==="Medu") {//return false;
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 .range([h, 0]);
            // }
            // else if (d ==="romantic"){//return false;
            //     y[d] = d3.scale.ordinal()
            //                 .domain(students.map(function(p) { return p[d]; }))
            //                 .rangePoints([0, h/2]);
            // }
            // else if (d === "Fedu"){
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 .range([h, 0]);
            // }
           // if (d === "traveltime"){
           //      y[d] = d3.scale.linear()
           //                  .domain(d3.extent(data,function(p){return +p[d];}))
           //                  .range([h,0]);
           //  }
            if (d === "studytime"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "failures"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            // else if (d === "famrel"){
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 //.domain([0,20])
            //                 .range([h,0]);
            // }
            // else if (d === "freetime"){
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 //.domain([0,20])
            //                 .range([h,0]);
            // }
            else if (d === "goout"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "Dalc"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(students,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "Walc"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(students,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            // else if (d === "health"){
            //     y[d] = d3.scale.linear()
            //                 .domain(d3.extent(students,function(p){return +p[d];}))
            //                 //.domain([0,20])
            //                 .range([h,0]);
            // }
            else if (d === "absences"){
                y[d] = d3.scale.linear()
                            .domain(d3.extent(data,function(p){return +p[d];}))
                            //.domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G1"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G2"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else if (d === "G3"){
                y[d] = d3.scale.linear()
                            //.domain(d3.extent(students,function(p){return +p[d];}))
                            .domain([0,20])
                            .range([h,0]);
            }
            else{return false;}
            return true;
        }))



        //console.log(dimensions)
        // Add grey background lines for context
        background = svg1.append("svg:g")
                        .attr("class","background")
                        .selectAll("path")
                        .data(data)
                        .enter()
                        .append("svg:path")
                        .attr("d",path)
        // Add colorful foreground lines for focus
        foreground = svg1.append("svg:g")
                        .attr("class","foreground")
                        .selectAll("path")
                        .data(data)
                        .enter()
                        .append("svg:path")
                        .attr("d",path)
                        .attr("stroke", "steelblue")
                        .style("opacity",0.5)


        //Add a group element for each dimension
        var g  = svg1.selectAll(".dimension")
                    .data(dimensions)
                    .enter()
                    .append("svg:g")
                    .attr("class","dimension")
                    .attr("transform", function(d) { return "translate(" + x(d) + ")"; })
                    .call(d3.behavior.drag()
                        .origin(function(d) { return {x: x(d)} ;})//d is the element in dimensions
                        .on("dragstart", function(d) {
                            dragging[d] = x(d);
                            background.attr("visibility", "hidden");
                        })
                        .on("drag", function(d) {
                            dragging[d] = Math.min(w, Math.max(0, d3.event.x));
                           // console.log(dragging);
                            foreground.attr("d", path);
                            dimensions.sort(function(a, b) { return position(a) - position(b); });
                            x.domain(dimensions);
                            g.attr("transform", function(d) { return "translate(" + position(d) + ")"; })
                        })
                        .on("dragend", function(d) {
                            delete dragging[d];
                            transition(d3.select(this)).attr("transform", "translate(" + x(d) + ")");
                            transition(foreground)
                                .attr("d", path);
                            background
                                .attr("d", path)
                                .transition()
                                .delay(500)
                                .duration(0)
                                .attr("visibility", null);
                        }));
        //console.log(dragging)
        // Add an axis and title
        g.append("svg:g")
            .attr("class","axis")
            .each(function(d){
                d3.select(this).call(axis.scale(y[d]));
            })
            .append("svg:text")
            .attr("text-anchor", "middle")
            .attr("y", -9)
            .text(String)
            .attr("fill","black")
            .attr("font-size",13);

        // Add and store a brush for each axis.
        g.append("svg:g")
            .attr("class", "brush_p")
            .each(function(d) { 
                d3.select(this).call(y[d].brush = d3.svg.brush()
                                                    .y(y[d])
                                                    .on("brushstart", brushstart_p)
                                                    .on("brush", brush_p)); 
            })
            .selectAll("rect")
            .attr("x", -8)
            .attr("width", 16);
    }           

//-------------------------------------------------------------------------------------
//               parallel brush
//-------------------------------------------------------------------------------------  
        function position(d) {
            var v = dragging[d];
            return v == null ? x(d) : v;

        }

        function transition(g) {
            return g.transition().duration(500);
        }

        function path(d) {
            return line(dimensions.map(function(p) {
            return [position(p), y[p](d[p])]; }));
        }

        function brushstart_p() {
            d3.event.sourceEvent.stopPropagation();
        }


        // Handles a brush event, toggling the display of foreground lines.
        //var c =[];

        //var A, B, C, D, F;

        function brush_p() {
            var actives = dimensions.filter(function(p) { return !y[p].brush.empty(); }),
                extents = actives.map(function(p) { return y[p].brush.extent(); });
                //console.log(extents)
                //console.log(actives)

            //for parallel coordinates
            foreground.style("display", function(d) {
                return actives.every(function(p, i) {//restrict range
                    return extents[i][0] <= d[p] && d[p] <= extents[i][1];
                }) ? null : "none";
            });

            //get selected students when using brush in parallel
            //var select_student;

            select_student = students.filter(function(d){
                return actives.every(function(p, i){//restrict range
                    return extents[i][0] <= d[p] && d[p] <= extents[i][1];
                });
            })
            //console.log(select_student[1]["G3"]);
            //console.log(select_student.length);
            //console.log(count_number);

            //console.log(c)
            //return c

            //count();
            //console.log(c);          
            //bar(c);

            count(select_student);
            bar(c);

            selection.on("change",function(){
                s = this.value;
                //count_select_cate(s);
            })
            count_select_cate(s);
            draw_pie();          
            
        }
        //console.log(c);
        
        function count(data){
                        //divide student grade in A, B, C, D, and F
            //G3: A:16-20, B: 14-15, C: 12-13, D: 10-11, F:0-9
            //count number of selected students in ABCDF
            var i = 0;
            A = 0 , B = 0 , C = 0 , D = 0 , F = 0;
            c = [];
            while(i<data.length){
                if (data[i]["G3"] <= 20 && 16 <= data[i]["G3"]){
                    A = A +1;//console.log(A);

                }
                else if (data[i]["G3"] <= 15 && 14 <= data[i]["G3"]){
                    B = B + 1;
                }
                else if (data[i]["G3"] <= 13 && 12 <= data[i]["G3"]){
                    C = C + 1;
                }
                else if (data[i]["G3"] <= 11 && 10 <= data[i]["G3"]){
                    D = D + 1;
                }
                else if (data[i]["G3"] <= 9 && 0 <= data[i]["G3"]){
                    F = F + 1;
                };

                i++;
            }
            //console.log(A);
            c.push(A); //console.log(c);
            c.push(B);
            c.push(C);
            c.push(D);
            c.push(F);
            return c
           //console.log(c);

        }
        
        function bar(data){
            svg2.selectAll(".bar").transition()
                .remove();
            svg2.selectAll(".axis")//.transition()
                .remove();
            svg2.selectAll(".title").remove()

            ybar.domain([0,d3.max(data,function(d){return d;})])
            var bars = svg2.append("svg:g")
                            .attr("class","bar")
                            .selectAll("rect")
                            .data(data)
                            .enter()
                            .append("rect")
                            .attr("x",function(d,i){
                                return 25 + i*90;
                            })
                            .attr("y",function(d){
                                //return h2 - ybar(d);
                                return  ybar(d);
                                //return d;
                            })
                            .attr("width",50)
                            .attr("height",function(d){
                                return h2 - ybar(d);
                                //return d;
                            })
                            .attr("fill",function(d,i){
                                return b_color(i);
                            })
                            .attr("opacity",1)
                            //.transition()
                            //.duration(1550);

            svg2.append("svg:g")
                .attr("class","axis")
                .attr("transform", "translate(0," + (h2) + ")")
                .call(b_xAixs)
                .append("text");

            svg2.append("svg:g")
                .attr("class","axis")
                .attr("transform", "translate(" + 20 + ",0)")
                .call(b_yAixs);

            svg2.append("text")
                .attr("x",140)
                .attr("y",0)
                .text("Students Number")
                .style("font-size","25px")
                .attr("class","title");

            // svg2.selectAll("text")
            //     .data(data)
            //     .enter()
            //     .append("text")
            //     // .attr("x",function(d,i){
            //     //     return 10 + i *50;
            //     // })
            //     .attr("x",function(d,i){
            //         return i * 90
            //     })
            //     .attr("y",function(d){
            //         return 40;
            //     })
            //     .attr("y",20)
            //     .text(function(d){
            //         return d;
            //     });

            // svg2.append("text")
            //     .attr("transform", "rotate(-90)")
            //     .attr("y", 6)
            //     .attr("dy", ".71em")
            //     .style("text-anchor", "end")
            //     .text("Number");

            //highlight selected bar
            // bars.on("mouseover",function(d){
            //     d3.select(this)
            //         .attr("fill","orange")
            //     })
            //     .on("mouseout",function(d){
            //         d3.select(this).transition()
            //                         .attr("fill","red");
            //     })



        }    

        var selection = d3.select("#pie")
                            .append("div")
                            .append("select")
                            .on("change",function(){
                                var s = this.value;
                                count_select_cate(s);
                                //svg3.selectAll(".arc").remove();
                                console.log(s);
                                draw_pie();

                            });

        selection.selectAll("option")
                    .data(category_variable)  
                    .enter()
                    .append("option")
                    .attr("value",function(d){
                        return d;
                    })
                    .text(function(d){return d});

        //get unique value of picked category
        function count_select_cate(d){
            var cate_info = ["1"];
            select_student.forEach(function(p){
                    //console.log(p);
                for(var i = 0; i<cate_info.length;i++){
                    //console.log("ok")
                    if(cate_info.indexOf(p[d]) !== -1 ){
                        //console.log("this value is already there.");
                    }
                    else{
                        cate_info.push(p[d]);
                        //console.log(cate_info);
                    }
                }
            })
            //console.log(cate_info);
            Cate_info = [];
            for(var i = 1; i<cate_info.length;i++){
                Cate_info.push(cate_info[i]);
            }
            // //console.log(Cate_info);
            // //display_cate_info(Cate_info);
            c_pie = [];
            for(var i = 0; i < Cate_info.length;i++){
                c_pie.push(0);
            }

            for(var i = 0; i< Cate_info.length;i++){
                for(var j = 0;j< select_student.length;j++){
                    if(select_student[j][d] == Cate_info[i]){
                        c_pie[i] = c_pie[i] + 1;
                    }
                }
            }


        }

        function draw_pie(){
            svg3.selectAll(".arc").remove();
            var pieChart = svg3.selectAll("arc")
                        .data(pie(c_pie))
                        .enter()
                        .append("svg:g")
                        .attr("class","arc")
                        .attr("transform", "translate(" + (outerR + 50) + ", " + outerR + ")");;

            pieChart.append("path")
                    .attr("d",arc)
                    .style("fill",function(d,i){
                        return pie_color(i);
                    })

            pieChart.append("text")
                    .attr("transform", function(d) { return "translate(" + labelArc.centroid(d) + ")"; })
                    .attr("dy", ".35em")
                    .text(function(d) { return d.data; })
                    .style("text-anchor","middle");

            svg3.selectAll(".rect").remove();
            var rects = svg3.selectAll("rect")
                            .data(Cate_info)
                            .enter()
                            .append("svg:g")
                            .attr("class","rect");

            rects.append("rect")
                    .attr("x",w3 - 100)
                    .attr("y",function(d,i){
                        return h3/2 + i*20;
                    })
                    .attr("width",12)
                    .attr("height",12)
                    .style("fill",function(d,i){
                        return pie_color(i);
                    })

            rects.append("text")
                    .attr("x", w3 - 80)
                    .attr("y", function(d,i){
                        return h3/2 + 10 + i*20;
                    })
                    .text(function(d){return d})
                    .style("font-size","15px")
                    //.attr("class","title")

        }




        




     });
    
	


    </script>

  </body>
</html>

